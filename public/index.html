<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot Node + MySQL</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        margin: 0;
        background: #f2f4f8;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .chat-container {
        background: #ffffff;
        width: min(600px, 95vw);
        height: min(80vh, 800px);
        border-radius: 16px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        background: linear-gradient(120deg, #2563eb, #7c3aed);
        color: #fff;
        padding: 20px;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      #messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #f8fafc;
      }

      .message {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 14px;
        line-height: 1.4;
        box-shadow: 0 5px 15px rgba(15, 23, 42, 0.08);
      }

      .message.user {
        align-self: flex-end;
        background: #2563eb;
        color: #fff;
        border-bottom-right-radius: 4px;
      }

      .message.bot {
        align-self: flex-start;
        background: #fff;
        color: #0f172a;
        border-bottom-left-radius: 4px;
      }

      form {
        display: flex;
        gap: 10px;
        padding: 16px;
        background: #fff;
        border-top: 1px solid #e2e8f0;
      }

      input,
      button {
        font-size: 1rem;
        border-radius: 999px;
        border: 1px solid #cbd5f5;
        padding: 12px 16px;
      }

      input[type="text"] {
        flex: 1;
        border: 1px solid #cbd5f5;
        background: #f1f5f9;
        transition: border 0.2s ease;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #2563eb;
        background: #fff;
      }

      button {
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        border: none;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <header>
        <h1>Chatbot com Node.js & MySQL</h1>
        <p style="margin: 4px 0 0">Converse e armazene o hist√≥rico no banco de dados.</p>
      </header>
      <main id="messages"></main>
      <form id="chat-form">
        <input
          type="text"
          id="author"
          name="author"
          placeholder="Seu nome"
          required
        />
        <input
          type="text"
          id="message"
          name="message"
          placeholder="Escreva sua mensagem"
          required
        />
        <button type="submit">Enviar</button>
      </form>
    </div>

    <script>
      const messagesContainer = document.getElementById('messages');
      const form = document.getElementById('chat-form');
      const authorInput = document.getElementById('author');
      const messageInput = document.getElementById('message');

      async function fetchMessages() {
        try {
          const response = await fetch('/api/messages');
          if (!response.ok) {
            throw new Error('Erro ao buscar mensagens');
          }
          const messages = await response.json();
          renderMessages(messages);
        } catch (error) {
          console.error(error);
        }
      }

      function renderMessages(messages) {
        messagesContainer.innerHTML = '';
        messages.forEach((message) => {
          const div = document.createElement('div');
          div.classList.add('message');
          const isBot = message.author.toLowerCase() === 'bot';
          div.classList.add(isBot ? 'bot' : 'user');
          const time = new Date(message.created_at).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
          });
          div.innerHTML = `<strong>${message.author}</strong> <small>${time}</small><br />${message.content}`;
          messagesContainer.appendChild(div);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      async function sendMessage(author, content) {
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ author, content })
        });

        if (!response.ok) {
          const { error } = await response.json();
          throw new Error(error || 'Erro ao enviar mensagem');
        }

        return response.json();
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const author = authorInput.value.trim();
        const content = messageInput.value.trim();
        if (!author || !content) {
          return;
        }

        form.querySelector('button').disabled = true;

        try {
          await sendMessage(author, content);
          messageInput.value = '';
          await fetchMessages();
        } catch (error) {
          alert(error.message);
        } finally {
          form.querySelector('button').disabled = false;
          messageInput.focus();
        }
      });

      fetchMessages();
      setInterval(fetchMessages, 5000);
    </script>
  </body>
</html>
